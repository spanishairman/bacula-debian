#### Bacula. Установка и настройка в операционной системе Debian Bookworm
`Bacula — это набор компьютерных программ, позволяющий системному администратору управлять резервным копированием, восстановлением и проверкой компьютерных данных в сети компьютеров разных типов. Bacula также может работать полностью на одном компьютере и может выполнять резервное копирование на различные типы носителей, включая ленту и диск.`
[Источник](https://www.bacula.org/what-is-bacula/)
#### Компоненты Bacula

  -  **_Bacula Director_** - центральная управляющая программа для всех остальных демонов. Он планирует и контролирует все операции резервного копирования, восстановления, проверки и архивирования. Системный администратор использует Bacula Director для планирования резервного копирования и восстановления файлов. Директор работает как демон (или служба) в фоновом режиме.
  -  **_The Bacula Console_** - это программа, которая позволяет администратору или пользователю общаться с Bacula Director. Он запускается в окне консоли (интерфейс TTY).
  -  **_Bacula File Daemon_** - это программа, которая должна быть установлена на каждом (клиентском) компьютере, для которого необходимо создать резервную копию. По запросу директора Bacula он находит файлы для резервного копирования и отправляет их (их данные) в демон хранения Bacula.
  -  **_Bacula Storage Daemon_** - По запросу от Bacula Director, Storage Daemon отвечает за прием данных от Bacula File Daemon и сохранение атрибутов и данных файла на физическом носителе или томах резервного копирования. В случае запроса на восстановление он отвечает за поиск данных и отправку их демону файлов Baacula. В вашей среде может быть несколько демонов Bacula Storage, каждый из которых контролируется одним и тем же директором Bacula. Службы хранилища работают как демон на компьютере с устройством резервного копирования (например, на ленточном накопителе).
  -  **_Catalog_** - Службы каталога состоят из программ, отвечающих за поддержание файловых индексов и баз данных томов для всех резервных копий файлов. Службы каталога позволяют системному администратору или пользователю быстро найти и восстановить любой нужный файл. Службы каталога устанавливают Bacula отдельно от простых программ резервного копирования, таких как tar и bru, поскольку в каталоге ведется запись всех используемых томов, всех выполненных заданий и всех сохраненных файлов, что обеспечивает эффективное восстановление и управление томами. В настоящее время Bacula поддерживает три разные базы данных: MySQL, PostgreSQL и SQLite, одну из которых необходимо выбрать при сборке Bacula.

![Bacula](bacula.png)

#### Термины
  - **_Client_** - в терминологии _Bacula_ слово _Client_ относится к резервируемому компьютеру и является синонимом Файловых служб или Файлового демона, и довольно часто его называют File Daemon. Клиент определяется в ресурсе файла конфигурации;
  - **_Directive_** - термин _Directive_ используется для обозначения оператора или записи в ресурсе в файле конфигурации, который определяет один конкретный параметр. Например, директива Name определяет имя ресурса;
  - **_File Attributes_** -  это вся информация, необходимая для идентификации файла и все его свойства, такие как размер, дата создания, дата изменения, разрешения и т.д. Обычно атрибуты полностью обрабатываются Baculs, так что пользователю никогда не нужно беспокоиться о них. Атрибуты не содержат данные файла.
  - **_FileSet_** - ресурс, содержащийся в файле конфигурации, который определяет файлы для резервного копирования. Он состоит из списка включенных файлов или каталогов, списка исключенных файлов и способа хранения файла (сжатие, шифрование, подписи). Для получения дополнительной информации;
  - **_Differential_** - разностная резервная копия включает все файлы, измененные с момента начала последнего полного сохранения. Обратите внимание, что другие программы резервного копирования могут определять это по-другому;
  - **_Incremental_** - инкрементное резервное копирование включает все файлы, измененные с момента запуска последнего полного, разностного или инкрементного резервного копирования. Обычно он указывается в директиве Level в определении ресурса Job или в ресурсе Schedule;
  - **_Resource_** - ресурс является частью файла конфигурации, который определяет конкретную единицу информации, доступную для Bacula. Он состоит из нескольких директив (отдельных операторов конфигурации). Например, ресурс задания определяет все свойства конкретного задания: имя, расписание, пул томов, тип резервного копирования, уровень резервного копирования, и т.д.;
  - **_Job_** - задание в _Bacula_ - это ресурс конфигурации, который определяет работу, которую Bacula должна выполнить для резервного копирования или восстановления конкретного клиента. Он состоит из типа (резервное копирование, восстановление, проверка и т.д.), Уровня (полный, дифференциальный, инкрементный и т.д.), Набора файлов и хранилища, для которого необходимо создать резервные копии файлов (устройство хранения, пул носителей);
  - **_Restore_** -  ресурс конфигурации, который описывает операцию восстановления файла с носителя резервной копии. Это обратное сохранение, за исключением того, что в большинстве случаев для восстановления обычно требуется небольшой набор файлов для восстановления, в то время как обычно для сохранения создаются резервные копии всех файлов в системе. Конечно, после сбоя диска Bareos можно вызвать для полного восстановления всех файлов, которые были в системе;
  - **_Retention Period_** - Существуют различные виды периодов хранения, которые распознает Bacula. Наиболее важными являются:
     - период хранения файлов,
     - период хранения заданий,
     - период хранения томов.

       - **_Период хранения файлов_** определяет время хранения записей о файлах в базе данных каталога. Этот период важен по двум причинам: во-первых, пока записи файлов остаются в базе данных, вы можете «просматривать» базу данных с помощью консольной программы и восстанавливать любой отдельный файл. После того как записи о файлах удалены (removed) или усечены (pruned) из базы данных, отдельные файлы задания резервного копирования больше не могут быть «просмотрены». Вторая причина, по которой следует тщательно выбирать период хранения записей файлов, заключается в том, что объем файловых записей базы данных занимает больше всего места в базе данных. Как следствие, вы должны убедиться, что регулярное «усечение» записей файла базы данных выполняется, чтобы предотвратить слишком большой рост вашей базы данных. (см. команду _prune_ в _Console_ для более подробной информации по этому вопросу).

       - **_Период хранения заданий_** - это период времени, в течение которого записи работ будут храниться в базе данных. Обратите внимание, что все записи файла связаны с заданием, которое сохранило эти файлы. Записи файла могут быть удалены, оставляя записи задания. В этом случае будет доступна информация о запущенных заданиях, но не информация о файлах, для которых было выполнено резервное копирование. Обычно при очистке записи задания все записи файла также удаляются.

       - **_Период хранения тома_** - это минимальное время хранения _тома_ до его повторного использования. Обычно _Bacula_ никогда не перезаписывает _том_, содержащий единственную резервную копию файла. В идеальных условиях в _каталоге_ будут храниться записи для всех файлов, для которых созданы резервные копии для всех текущих _томов_. После перезаписи _тома_ файлы, для которых было выполнено резервное копирование, автоматически удаляются из _каталога_. Однако, если существует очень большой _пул томов_ (pool of Volumes) или _том_ (Volume) никогда не перезаписывается, база данных _каталога_ (Catalog) может стать огромной. Чтобы сохранить _каталог_ в управляемом размере, информация о резервной копии должна быть удалена из каталога после определенного периода хранения файлов. _Bacula_ предоставляет механизмы автоматического усечения _каталога_ в соответствии с определенными периодами хранения. 
      > [!IMPORTANT]
      > Каждый из этих периодов хранения применяется ко времени, когда конкретные записи будут храниться в базе данных каталога. Их не следует путать со сроком действия данных, сохраненных на _томе_;
  - **_Scan_** - операция сканирования вызывает сканирование содержимого _тома_ или серии _томов_. Информация о том, какие файлы содержат эти _тома_, восстанавливается в каталоге _Bacula_. Как только информация восстановлена в _базе данных_ (Catalog), файлы, содержащиеся в этих _томах_ (Volumes), могут быть легко восстановлены. Эта функция особенно полезна, если определенные _тома_ или _задания_ превысили срок хранения и были удалены или удалены из _каталога_. Сканирование данных из _томов_ в _каталог_ осуществляется с помощью программы _bscan_.

#### Установка
_Bacula_, в отличие от _Bareos_ присутствует в стандартных репозиториях _Debian_, поэтому для установки воспользуемся пакетным менеджером _Apt_:
```
apt install bacula
```

> [!NOTE]
> При установке метапакета _Bacula_ устанавливаются следующий перечень пакетов: 
>
> `bacula-bscan bacula-client bacula-common bacula-common-pgsql bacula-console bacula-director bacula-director-pgsql bacula-fd bacula-sd bacula-server bsd-mailx dbconfig-common dbconfig-pgsql exim4-base exim4-config exim4-daemon-light libcommon-sense-perl
> libgnutls-dane0 libjson-perl libjson-xs-perl libllvm14 liblockfile1 libpq5 libtypes-serialiser-perl libunbound8 mt-st mtx postgresql postgresql-15 postgresql-client postgresql-client-15 postgresql-client-common postgresql-common sysstat`.
>
> По крайней мере, один пакет из данного списка, а имненно _bacula-director-pgsq_, потребует интерактивной настройки.

![Настройка пакета _bacula-director-pgsql_](20240910-01.png)

Чтобы избежать такого поведения, например, при автоматизированной установке, необходимо перед запуском `apt install` задать переменную **_DEBIAN_FRONTEND=noninteractive_** таким образом: `export DEBIAN_FRONTEND=noninteractive`. Тогда установщик при настройке _Bacula Catalog_ назначит параметры по умолчанию:
```# Generic catalog service
  Catalog {
  Name = MyCatalog
  dbname = "bacula"; DB Address = "localhost"; dbuser = "bacula"; dbpassword = "Password"
}
```
где __Password__ - произвольный пароль, созданный инсталлятором.

База данных для Bacula создается автоматически установщиком:
```
root@debian12:/etc/bacula# su postgres 
postgres@debian12:/etc/bacula$ psql -d bacula
psql (15.8 (Debian 15.8-0+deb12u1))
Введите "help", чтобы получить справку.

bacula=# \dt
               Список отношений
 Схема  |      Имя       |   Тип   | Владелец 
--------+----------------+---------+----------
 public | basefiles      | таблица | bacula
 public | cdimages       | таблица | bacula
 public | client         | таблица | bacula
 public | counters       | таблица | bacula
 public | device         | таблица | bacula
 public | file           | таблица | bacula
 public | filename       | таблица | bacula
 public | fileset        | таблица | bacula
 public | job            | таблица | bacula
 public | jobhisto       | таблица | bacula
 public | jobmedia       | таблица | bacula
 public | location       | таблица | bacula
 public | locationlog    | таблица | bacula
 public | log            | таблица | bacula
 public | media          | таблица | bacula
 public | mediatype      | таблица | bacula
 public | path           | таблица | bacula
 public | pathhierarchy  | таблица | bacula
 public | pathvisibility | таблица | bacula
 public | pool           | таблица | bacula
 public | restoreobject  | таблица | bacula
 public | snapshot       | таблица | bacula
 public | status         | таблица | bacula
 public | storage        | таблица | bacula
 public | unsavedfiles   | таблица | bacula
 public | version        | таблица | bacula
(26 строк)
```
Для того, чтобы пользователь (vagrant в данном случае) мог пользоваться графическим приложением Bacula Admin Tool - bat, добавим его в группу bacula. 
```
root@debian12:/etc/bacula# usermod -a -G bacula vagrant
```
