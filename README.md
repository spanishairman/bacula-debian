### Bacula. Установка и настройка в операционной системе Debian Bookworm
`Bacula — это набор компьютерных программ, позволяющий системному администратору управлять резервным копированием, восстановлением и проверкой компьютерных данных в сети компьютеров разных типов. Bacula также может работать полностью на одном компьютере и может выполнять резервное копирование на различные типы носителей, включая ленту и диск.`
[Источник](https://www.bacula.org/what-is-bacula/)
#### Компоненты Bacula

  -  **_Bacula Director_** - центральная управляющая программа для всех остальных демонов. Он планирует и контролирует все операции резервного копирования, восстановления, проверки и архивирования. Системный администратор использует Bacula Director для планирования резервного копирования и восстановления файлов. Директор работает как демон (или служба) в фоновом режиме.
  -  **_The Bacula Console_** - это программа, которая позволяет администратору или пользователю общаться с Bacula Director. Он запускается в окне консоли (интерфейс TTY).
  -  **_Bacula File Daemon_** - это программа, которая должна быть установлена на каждом (клиентском) компьютере, для которого необходимо создать резервную копию. По запросу директора Bacula он находит файлы для резервного копирования и отправляет их (их данные) в демон хранения Bacula.
  -  **_Bacula Storage Daemon_** - По запросу от Bacula Director, Storage Daemon отвечает за прием данных от Bacula File Daemon и сохранение атрибутов и данных файла на физическом носителе или томах резервного копирования. В случае запроса на восстановление он отвечает за поиск данных и отправку их демону файлов Baacula. В вашей среде может быть несколько демонов Bacula Storage, каждый из которых контролируется одним и тем же директором Bacula. Службы хранилища работают как демон на компьютере с устройством резервного копирования (например, на ленточном накопителе).
  -  **_Catalog_** - Службы каталога состоят из программ, отвечающих за поддержание файловых индексов и баз данных томов для всех резервных копий файлов. Службы каталога позволяют системному администратору или пользователю быстро найти и восстановить любой нужный файл. Службы каталога устанавливают Bacula отдельно от простых программ резервного копирования, таких как tar и bru, поскольку в каталоге ведется запись всех используемых томов, всех выполненных заданий и всех сохраненных файлов, что обеспечивает эффективное восстановление и управление томами. В настоящее время Bacula поддерживает три разные базы данных: MySQL, PostgreSQL и SQLite, одну из которых необходимо выбрать при сборке Bacula.

![Bacula](bacula.png)

Сетевые взаимодействия между компонентами _Bacula_. 

Для корректной работы, нам потребуется открыть некоторые порты на межсетевом экране, если такой имеется в нашей сети. Следующий список поможет настроить правила файервола:
```
Console       -> Director:9101
Director      -> Storage Daemon:9103
Director      -> File Daemon:9102
File Daemon   -> Storage Daemon:9103
```

#### Термины
  - **_Client_** - в терминологии _Bacula_ слово _Client_ относится к резервируемому компьютеру и является синонимом Файловых служб или Файлового демона, и довольно часто его называют File Daemon. Клиент определяется в ресурсе файла конфигурации;
  - **_Directive_** - термин _Directive_ используется для обозначения оператора или записи в ресурсе в файле конфигурации, который определяет один конкретный параметр. Например, директива Name определяет имя ресурса;
  - **_File Attributes_** -  это вся информация, необходимая для идентификации файла и все его свойства, такие как размер, дата создания, дата изменения, разрешения и т.д. Обычно атрибуты полностью обрабатываются Baculs, так что пользователю никогда не нужно беспокоиться о них. Атрибуты не содержат данные файла.
  - **_FileSet_** - ресурс, содержащийся в файле конфигурации, который определяет файлы для резервного копирования. Он состоит из списка включенных файлов или каталогов, списка исключенных файлов и способа хранения файла (сжатие, шифрование, подписи). Для получения дополнительной информации;
  - **_Differential_** - разностная резервная копия включает все файлы, измененные с момента начала последнего полного сохранения. Обратите внимание, что другие программы резервного копирования могут определять это по-другому;
  - **_Incremental_** - инкрементное резервное копирование включает все файлы, измененные с момента запуска последнего полного, разностного или инкрементного резервного копирования. Обычно он указывается в директиве Level в определении ресурса Job или в ресурсе Schedule;
  - **_Resource_** - ресурс является частью файла конфигурации, который определяет конкретную единицу информации, доступную для Bacula. Он состоит из нескольких директив (отдельных операторов конфигурации). Например, ресурс задания определяет все свойства конкретного задания: имя, расписание, пул томов, тип резервного копирования, уровень резервного копирования, и т.д.;
  - **_Job_** - задание в _Bacula_ - это ресурс конфигурации, который определяет работу, которую Bacula должна выполнить для резервного копирования или восстановления конкретного клиента. Он состоит из типа (резервное копирование, восстановление, проверка и т.д.), Уровня (полный, дифференциальный, инкрементный и т.д.), Набора файлов и хранилища, для которого необходимо создать резервные копии файлов (устройство хранения, пул носителей);
  - **_JobDefs_** - необязательный ресурс для предоставления значений по умолчанию для ресурсов Job. Т.о. - JobDefs представляет собой шаблон со значениями, которые часто используются в ресурсах Job, позволяющий сократить ваши настройки и облегчить чтение конфигурации;
  - **_Restore_** -  ресурс конфигурации, который описывает операцию восстановления файла с носителя резервной копии. Это обратное сохранение, за исключением того, что в большинстве случаев для восстановления обычно требуется небольшой набор файлов для восстановления, в то время как обычно для сохранения создаются резервные копии всех файлов в системе. Конечно, после сбоя диска Bareos можно вызвать для полного восстановления всех файлов, которые были в системе;
  - **_Retention Period_** - Существуют различные виды периодов хранения, которые распознает Bacula. Наиболее важными являются:
     - период хранения файлов,
     - период хранения заданий,
     - период хранения томов.

       - **_Период хранения файлов_** определяет время хранения записей о файлах в базе данных каталога. Этот период важен по двум причинам: во-первых, пока записи файлов остаются в базе данных, вы можете «просматривать» базу данных с помощью консольной программы и восстанавливать любой отдельный файл. После того как записи о файлах удалены (removed) или усечены (pruned) из базы данных, отдельные файлы задания резервного копирования больше не могут быть «просмотрены». Вторая причина, по которой следует тщательно выбирать период хранения записей файлов, заключается в том, что объем файловых записей базы данных занимает больше всего места в базе данных. Как следствие, вы должны убедиться, что регулярное «усечение» записей файла базы данных выполняется, чтобы предотвратить слишком большой рост вашей базы данных. (см. команду _prune_ в _Console_ для более подробной информации по этому вопросу).

       - **_Период хранения заданий_** - это период времени, в течение которого записи работ будут храниться в базе данных. Обратите внимание, что все записи файла связаны с заданием, которое сохранило эти файлы. Записи файла могут быть удалены, оставляя записи задания. В этом случае будет доступна информация о запущенных заданиях, но не информация о файлах, для которых было выполнено резервное копирование. Обычно при очистке записи задания все записи файла также удаляются.

       - **_Период хранения тома_** - это минимальное время хранения _тома_ до его повторного использования. Обычно _Bacula_ никогда не перезаписывает _том_, содержащий единственную резервную копию файла. В идеальных условиях в _каталоге_ будут храниться записи для всех файлов, для которых созданы резервные копии для всех текущих _томов_. После перезаписи _тома_ файлы, для которых было выполнено резервное копирование, автоматически удаляются из _каталога_. Однако, если существует очень большой _пул томов_ (pool of Volumes) или _том_ (Volume) никогда не перезаписывается, база данных _каталога_ (Catalog) может стать огромной. Чтобы сохранить _каталог_ в управляемом размере, информация о резервной копии должна быть удалена из каталога после определенного периода хранения файлов. _Bacula_ предоставляет механизмы автоматического усечения _каталога_ в соответствии с определенными периодами хранения. 
> [!IMPORTANT]
> Каждый из этих периодов хранения применяется ко времени, когда конкретные записи будут храниться в базе данных каталога. Их не следует путать со сроком действия данных, сохраненных на _томе_.
  - **_Scan_** - операция сканирования вызывает сканирование содержимого _тома_ или серии _томов_. Информация о том, какие файлы содержат эти _тома_, восстанавливается в каталоге _Bacula_. Как только информация восстановлена в _базе данных_ (Catalog), файлы, содержащиеся в этих _томах_ (Volumes), могут быть легко восстановлены. Эта функция особенно полезна, если определенные _тома_ или _задания_ превысили срок хранения и были удалены или удалены из _каталога_. Сканирование данных из _томов_ в _каталог_ осуществляется с помощью программы _bscan_.

#### Установка
_Bacula_, в отличие от _Bareos_ присутствует в стандартных репозиториях _Debian_, поэтому для установки воспользуемся пакетным менеджером _Apt_:
```
apt install bacula
```

> [!NOTE]
> При установке метапакета _Bacula_ устанавливаются следующий перечень пакетов: 
>
> `bacula-bscan bacula-client bacula-common bacula-common-pgsql bacula-console bacula-director bacula-director-pgsql bacula-fd bacula-sd bacula-server bsd-mailx dbconfig-common dbconfig-pgsql exim4-base exim4-config exim4-daemon-light libcommon-sense-perl
> libgnutls-dane0 libjson-perl libjson-xs-perl libllvm14 liblockfile1 libpq5 libtypes-serialiser-perl libunbound8 mt-st mtx postgresql postgresql-15 postgresql-client postgresql-client-15 postgresql-client-common postgresql-common sysstat`.
>
> По крайней мере, один пакет из данного списка, а имненно _bacula-director-pgsq_, потребует интерактивной настройки.

![Настройка пакета _bacula-director-pgsql_](20240910-01.png)

Чтобы избежать такого поведения, например, при автоматизированной установке, необходимо перед запуском `apt install` задать переменную **_DEBIAN_FRONTEND=noninteractive_** таким образом: `export DEBIAN_FRONTEND=noninteractive`. Тогда установщик при настройке _Bacula Catalog_ назначит параметры по умолчанию:
```# Generic catalog service
  Catalog {
  Name = MyCatalog
  dbname = "bacula"; DB Address = "localhost"; dbuser = "bacula"; dbpassword = "Password"
}
```
где __Password__ - произвольный пароль, созданный инсталлятором.

База данных для Bacula создается автоматически установщиком:
```
root@debian12:/etc/bacula# su postgres 
postgres@debian12:/etc/bacula$ psql -d bacula
psql (15.8 (Debian 15.8-0+deb12u1))
Введите "help", чтобы получить справку.

bacula=# \dt
               Список отношений
 Схема  |      Имя       |   Тип   | Владелец 
--------+----------------+---------+----------
 public | basefiles      | таблица | bacula
 public | cdimages       | таблица | bacula
 public | client         | таблица | bacula
 public | counters       | таблица | bacula
 public | device         | таблица | bacula
 public | file           | таблица | bacula
 public | filename       | таблица | bacula
 public | fileset        | таблица | bacula
 public | job            | таблица | bacula
 public | jobhisto       | таблица | bacula
 public | jobmedia       | таблица | bacula
 public | location       | таблица | bacula
 public | locationlog    | таблица | bacula
 public | log            | таблица | bacula
 public | media          | таблица | bacula
 public | mediatype      | таблица | bacula
 public | path           | таблица | bacula
 public | pathhierarchy  | таблица | bacula
 public | pathvisibility | таблица | bacula
 public | pool           | таблица | bacula
 public | restoreobject  | таблица | bacula
 public | snapshot       | таблица | bacula
 public | status         | таблица | bacula
 public | storage        | таблица | bacula
 public | unsavedfiles   | таблица | bacula
 public | version        | таблица | bacula
(26 строк)
```

##### Настройка на сервере
Для того, чтобы пользователь (_vagrant_ в данном случае) мог пользоваться графическим приложением _Bacula Admin Tool - bat_, добавим его в группу _bacula_. 
```
root@debian12:/etc/bacula# usermod -a -G bacula vagrant
```
###### Блок настроек Director
> [!NOTE]
> Director - Главный демон сервера Bacula, который планирует и направляет все операции Bacula. Сокращённое обозначение в тексте документации - DIR.

```
#
# Default Bacula Director Configuration file
#
#  The only thing that MUST be changed is to add one or more
#   file or directory names in the Include directive of the
#   FileSet resource.
#
#  For Bacula release 9.6.7 (10 December 2020) -- debian bookworm/sid
#
#  You might also want to change the default email address
#   from root to your address.  See the "mail" and "operator"
#   directives in the Messages resource.
#
# Copyright (C) 2000-2020 Kern Sibbald
# License: BSD 2-Clause; see file LICENSE-FOSS
#

Director {                            # define myself
  Name = debian12-dir
  DIRport = 9101                # where we listen for UA connections
  QueryFile = "/etc/bacula/scripts/query.sql"
  WorkingDirectory = "/var/lib/bacula"
  PidDirectory = "/run/bacula"
  Maximum Concurrent Jobs = 20
  Password = "QU3EOkh3mnNp1oe4DLbXCJ4uRLaWZMxVD"         # Console password
  Messages = Daemon
  DirAddress = 0.0.0.0  
}
```
Здесь мы изменили сетевой адрес, на котором доступен демон _Director_, остальные настройки остались от установщика.

###### Блок настроек Jobdefs
_Шаблоны задач_. Некоторые параметры для различных задач _Job_ могут повторяться. Поэтому такие параметры можно вынести в блоки _Jobdefs_ чтобы затем ссылаться на них из блоков _Job_ и сократить таким образом количество вносимых параметров. 
```
JobDefs {
  Name = "My-Full-Tpl"
  Type = Backup
  Level = Full
  Storage = FileSD
  Messages = Standard
  SpoolAttributes = yes
  Priority = 10
  Write Bootstrap = "/var/lib/bacula/%c.bsr"
}
 
JobDefs {
  Name = "My-Diff-Tpl"
  Type = Backup
  Level = Differential
  Storage = FileSD
  Messages = Standard
  SpoolAttributes = yes
  Priority = 10
  Write Bootstrap = "/var/lib/bacula/%c.bsr"
}
 
JobDefs {
  Name = "My-Incr-Tpl"
  Type = Backup
  Level = Incremental
  Storage = FileSD
  Messages = Standard
  SpoolAttributes = yes
  Priority = 10
  Write Bootstrap = "/var/lib/bacula/%c.bsr"
}
```
###### Блок настроек Job

> [!NOTE]
> Job - Задание в _Bacula_ - это ресурс конфигурации, который определяет работу, которую _Bacula_ должна выполнить для резервного копирования или восстановления конкретного клиента. Он состоит из типа (резервное копирование, восстановление, проверка и т.д.), Уровня (полный, дифференциальный, инкрементный и т.д.), Набора файлов и хранилища, для которого необходимо создать резервные копии файлов (устройство хранения, пул носителей). 

Создадим две задачи - _Clnt1-fs-Job_ и _Clnt2-fs-Job_, в которых будут архивироваться каталоги, перечисленные в параметре _FileSet = "My-fs-FS"_. Это общий параметр для обеих задач и далее в конфигурационном файле мы зададим для него список каталогов, подлежащих резервному копированию.

Также здесь перечислены пулы для каждого из трёх типов резервных копий - полная, разностная и инкрементная. Пулы в каждой задаче свои и будут содержать тома только одного клиента - это необязательное условие, просто здесь я выбрал такой принцип для наглядности.

Расписание - также для каждого клиента своё.

Скрипты, выполняющиеся до и после задачи резервного копирования - запускаются на клиентской машине, т.е. на стороне File Daemon. 
Такие скрипты могут содержать команды по предварительному сжатию архивируемых файлов, копированию их в tar-архив или, например, sql-команды, выполняющие дамп баз данных. 
Скрипты, выполняющиеся после задачи резервного копирования, могут содержать команды по удалению архивируемых файлов или ранее созданных tar-архивов или sql-файлов.
> [!NOTE]
> Чтобы было легче ориентироваться, я для задач, пулов, расписаний и клиентов выбрал шаблонные имена, которые содержат общие части. 
> Например, для клиента _Debian12cl1-fd_ соответствует имя задачи _Clnt1-fs-Job_, пул _Clnt1-fs-Full_, расписание - _Clnt1-fs-Sdl_.

```
Job {
  Name = "Clnt1-fs-Job"
  Type = Backup
  FileSet = "My-fs-FS"
  Pool = Clnt1-fs-Full
  Full Backup Pool = Clnt1-fs-Full                  # write Full Backups into "Full" Pool         (#05)
  Differential Backup Pool = Clnt1-fs-Diff
  Incremental Backup Pool = Clnt1-fs-Incr           # write Incr Backups into "Incremental" Pool  (#11)
  Schedule = "Clnt1-fs-Sdl"
  JobDefs = "My-Full-Tpl"
  Client = "Debian12cl1-fd"
  ClientRunBeforeJob = "/etc/bacula/scripts/bacula-before-fs.sh" # скрипт выполняющийся до задачи
  ClientRunAfterJob = "/etc/bacula/scripts/bacula-after-fs.sh" # скрипт выполняющийся после задачи
}

Job {
  Name = "Clnt2-fs-Job"
  Type = Backup
  FileSet = "My-fs-FS"
  Pool = Clnt2-fs-Full
  Full Backup Pool = Clnt2-fs-Full                  # write Full Backups into "Full" Pool         (#05)
  Differential Backup Pool = Clnt2-fs-Diff
  Incremental Backup Pool = Clnt2-fs-Incr           # write Incr Backups into "Incremental" Pool  (#11)
  Schedule = "Clnt2-ds-Sdl"
  JobDefs = "My-Full-Tpl"
  Client = "Debian12cl2-fd"
#  ClientRunBeforeJob = "/etc/bacula/scripts/bacula-before-fs.sh" # скрипт выполняющийся до задачи
#  ClientRunAfterJob = "/etc/bacula/scripts/bacula-after-fs.sh" # скрипт выполняющийся после задачи
}
```

В примере ниже описывается стандартная задача восстановления на несуществующий носитель, как говорится в описании, этого достаточно для всех наборов Jobs, Clients, Storages. Я лишь изменил каталог по умолчанию, в который будут восстанавливаться данные. 
```
#
# Standard Restore template, to be changed by Console program
#  Only one such job is needed for all Jobs/Clients/Storage ...
#
Job {
  Name = "RestoreFiles"
  Type = Restore
  Client=debian12-fd
  Storage = File1
# The FileSet and Pool directives are not used by Restore Jobs
# but must not be removed
  FileSet="Full Set"
  Pool = File
  Messages = Standard
  Where = /bacula-restores
}
```
###### Наборы файлов - FileSet
> [!NOTE]
> Ресурс FileSet определяет, какие файлы должны быть включены в задании резервного копирования или исключены из него. Набор файлов требуется для каждого задания резервного копирования. Он состоит из списка файлов или каталогов, которые необходимо включить, списка файлов или каталогов, которые необходимо исключить, и различных параметров резервного копирования, таких как сжатие, шифрование и подписи, которые должны применяться к каждому файлу.

```
FileSet {
  Name = "My-fs-FS"
  Enable VSS = yes
  Include {
    Options {
      Signature = SHA1
      Compression = GZIP
      No Atime = yes
      Sparse = yes
      Checkfilechanges = yes
      IgnoreCase = no
    }
    File = "/etc"
    File = "/var"
  }
}
```
Здесь:
  - **_Name_** - имя набора файлов;
  - **_Enable VSS_** - Эта директива эффективна только для VSS включенных файловых демонов Win32. Она позволяет создавать согласованную копию открытых файлов для сотрудничающих записывающих приложений, а для приложений, которые не знают об VSSэтом, Bacula может по крайней мере получить доступ к открытым файлам. Значение по умолчанию — **_yes_**.
  - **_Signature_** - Подпись SHA1 будет вычисляться для каждого сохраненного файла. Предполагается, что алгоритм SHA1 несколько медленнее, чем алгоритм MD5, но в то же время он значительно лучше с криптографической точки зрения (т.е. гораздо меньше коллизий). Подпись SHA1 требует добавления 20 байтов на файл в ваш каталог.
  - **_Compression_** - Все сохраненные файлы будут программно сжаты с использованием формата сжатия GZIP. Сжатие выполняется файл за файлом файловым демоном. Для программного сжатия задания резервного копирования Bacula можно настроить на использование сжатия ZIP (уровни с 1 по 9, по умолчанию 6), LZO (уровень LZ01X) или zstd. LZO обеспечивает гораздо более высокую скорость сжатия и распаковки, но более низкую степень сжатия, чем GZIP.
  - **_No Atime_** - Если этот параметр включен и ваша операционная система поддерживает флаг открытия файла O_NOATIME, Bacula откроет все файлы для резервного копирования с этой опцией. Это позволяет читать файл без обновления atime inode (а также без обновления ctime inode, которое происходит, если вы пытаетесь установить atime обратно в его предыдущее значение). Это также предотвращает состояние гонки, когда две программы читают один и тот же файл, но только одна не хочет изменять время. Это наиболее полезно для программ резервного копирования и проверок целостности файлов (и bacula может соответствовать обеим категориям).
  - **_Sparse_** - Включает специальный код, который проверяет наличие разреженных файлов, например, созданных ndbm. Значение по умолчанию — no , поэтому для разреженных файлов проверки не производятся. Вы можете указать sparse=yes даже для файлов, которые не являются разреженными файлами. Вреда не будет, но будут небольшие дополнительные накладные расходы на проверку буферов, состоящих из одних нулей, и если есть блок размером 32 КБ, состоящий из одних нулей (см. ниже), этот блок станет дырой в файле, что может быть нежелательным, если исходный файл не был разреженным файлом.
  - **_Checkfilechanges_** - Если включено, клиент будет проверять размер и возраст каждого файла после резервного копирования, чтобы узнать, изменились ли они во время резервного копирования. Если время или размер не совпадают, возникнет ошибка. Значение по умолчанию — **_no_**.
  - **_IgnoreCase_** - Значение по умолчанию — no. В системах _Windows_ вы почти наверняка захотите установить это значение **_yes_** . Если эта директива установлена ​​в **_yes_**, регистр символов будет игнорироваться при сравнении с подстановочными знаками и регулярными выражениями. То есть заглавная буква A будет соответствовать строчной букве a.

####### Исключения из резервных копий. 
Для исключения файлов и каталогов при определении наборов файлов - _Fileset_ используется ресурс _Exclude_:
```
FileSet {
  Name = "Full Set"
  Include {
    Options {
      signature = MD5
    }
    File = /usr/sbin
  }
  Exclude {
    File = /var/lib/bacula
    File = /nonexistant/path/to/file/archive/dir
    File = /proc
    File = /tmp
    File = /sys
    File = /.journal
    File = /.fsck
  }
}
```
####### Подстановочные знаки
**wilddir=строка** - Указывает строку подстановочных знаков, которая будет применяться только к именам каталогов. Никакие имена файлов не будут сопоставлены этой директивой. Обратите внимание, если Exclude не включен, подстановочный знак выберет каталоги для включения. Если указано Exclude=yes , подстановочный знак выберет каталоги, которые следует исключить. Можно указать несколько директив подстановочных знаков, и они будут применяться по очереди, пока не будет найдена первая совпадающая. Обратите внимание, если вы исключите каталог, никакие файлы или каталоги под ним не будут сопоставлены. Рекомендуется заключить строку в двойные кавычки.

**wildfile=строка** - Указывает строку с подстановочными знаками, которая будет применяться к именам файлов, исключая каталоги. То есть ни одна запись каталога не будет сопоставлена ​​этой директивой. Однако обратите внимание, что сопоставление выполняется с полным путем и именем файла, поэтому ваша строка с подстановочными знаками должна учитывать, что именам файлов предшествует полный путь. Если Exclude не включен, подстановочный знак выберет, какие файлы должны быть включены. Если указано Exclude=yes , подстановочный знак выберет, какие файлы должны быть исключены. Можно указать несколько директив с подстановочными знаками, и они будут применяться по очереди, пока не будет найдена первая совпадающая. Рекомендуется заключить строку в двойные кавычки.

Пример:
```
FileSet {
  Name = "SRV01-DB-FS"
  Enable VSS = yes
  Include {
    Options {
      Signature = SHA1
      Compression = GZIP
      No Atime = yes
      Sparse = yes
      Checkfilechanges = yes
      Drive Type = fixed
      IgnoreCase = yes
      WildFile = "[A-Z]:/pagefile.sys"
      WildDir = "[A-Z]:/RECYCLER"
      WildDir = "[A-Z]:/$RECYCLE.BIN"
      WildDir = "[A-Z]:/System Volume Information"
      Exclude = yes
    }
    File = "F:/BackUP/"
  }
'''
